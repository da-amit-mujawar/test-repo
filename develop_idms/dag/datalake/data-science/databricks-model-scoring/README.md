# Data Bricks Model Score Automation

This DAG is used by Data Operations team to launch Data Bricks Jobs that score an Apogee or other ML models. Each model has set of parameters stored as json on *s3://axle-datascience/models/job_params/* 

## Example AI_AP_AIRFLOW_SCORING_TEST.json 

```
{
  "prefix": "2914546097787688/69791aaab5154ceab0ce9d8ad1b92470",
  "decile_bins": "{1: 0.65273154, 2: 0.5241026, 3: 0.4371717, 4: 0.36558425, 5: 0.30025068, 6: 0.2410927, 7: 0.19092056, 8: 0.14506991, 9: 0.10870984, 10: 0.018352484}",
  "ensemble": "False",
  "ventile_bins": "{1: 0.7539177, 2: 0.65273154, 3: 0.5790663, 4: 0.5241026, 5: 0.47792295, 6: 0.4371717, 7: 0.4001572, 8: 0.36558425, 9: 0.33243552, 10: 0.30025068, 11: 0.2700081, 12: 0.2410927, 13: 0.21514179, 14: 0.19092056, 15: 0.16696705, 16: 0.14506991, 17: 0.12785996, 18: 0.10870984, 19: 0.08410269, 20: 0.018352484}",
  "build": "2021-07-16",
  "centile_bins": "{1: 0.8916113, 2: 0.84983325, 3: 0.8154298, 4: 0.7833404, 5: 0.7539177, 6: 0.7287196, 7: 0.70610744, 8: 0.6851359, 9: 0.6709697, 10: 0.65273154, 11: 0.6356312, 12: 0.61993194, 13: 0.60544854, 14: 0.5917572, 15: 0.5790663, 16: 0.5669361, 17: 0.5555037, 18: 0.5447254, 19: 0.53431106, 20: 0.5241026, 21: 0.5145313, 22: 0.5049547, 23: 0.49574277, 24: 0.48669901, 25: 0.47792295, 26: 0.46929643, 27: 0.46102217, 28: 0.45295888, 29: 0.44497177, 30: 0.4371717, 31: 0.42952228, 32: 0.42187244, 33: 0.4144723, 34: 0.4073139, 35: 0.4001572, 36: 0.39299503, 37: 0.38582137, 38: 0.37891945, 39: 0.37225252, 40: 0.36558425, 41: 0.35895097, 42: 0.35219353, 43: 0.34564477, 44: 0.33902186, 45: 0.33243552, 46: 0.3258324, 47: 0.3193769, 48: 0.31294447, 49: 0.30660874, 50: 0.30025068, 51: 0.29398236, 52: 0.287892, 53: 0.28189552, 54: 0.27590218, 55: 0.2700081, 56: 0.26406285, 57: 0.25830913, 58: 0.25242978, 59: 0.2467269, 60: 0.2410927, 61: 0.2355638, 62: 0.23023571, 63: 0.22519596, 64: 0.22015254, 65: 0.21514179, 66: 0.21017401, 67: 0.20538105, 68: 0.20046288, 69: 0.1957123, 70: 0.19092056, 71: 0.18598989, 72: 0.18119974, 73: 0.1764101, 74: 0.17157412, 75: 0.16696705, 76: 0.16257721, 77: 0.15825169, 78: 0.15384363, 79: 0.14946909, 80: 0.14506991, 81: 0.14122729, 82: 0.13739167, 83: 0.13414313, 84: 0.13110037, 85: 0.12785996, 86: 0.12454464, 87: 0.12060726, 88: 0.11665582, 89: 0.112705946, 90: 0.10870984, 91: 0.10381247, 92: 0.09874233, 93: 0.09368464, 94: 0.08914125, 95: 0.08410269, 96: 0.07945915, 97: 0.07426592, 98: 0.0675895, 99: 0.058223918, 100: 0.018352484}",
  "client": "test ",
  "model_filename": "AI_AP_AIRFLOW_SCORING_TEST",
  "non_apogee": "False",
  "merge_advantage": "False",
  "jtk": "AIRFLOW",
  "recency_months": "12"
}
```

Upon successful completion of Data Bricks Job, a scored file is sent to IDMS for scoring the database and make it available in Campaign UI.
  
DAG must be run With Config option and list of models will be specified in json format. 

## Example of run time DAG argument

```
{
    "models" : [
                "AI_AP_TEST1",
                "AI_AP_TEST2",
                "AI_AP_TEST3"
                ]
}
```

# DAG Variables
- var-databricks-url : URL to call DataBricks RestAPI
- var-databricks-secret-token : Secret Token 
- var-datascience.databricks-score-job-id : Data Bricks Job ID
- var-email-on-failure-datalake : Email Notification is sent to this DL when DAG fails.
