drop table if exists mgen_new CASCADE;

create table mgen_new
(
lrfsid int ENCODE AZ64,
oldid varchar(12) ENCODE ZSTD,
cid varchar(18) ENCODE ZSTD,
firstname varchar(15) ENCODE ZSTD,
lastname varchar(20) ENCODE ZSTD,
fin_gen varchar(1) ENCODE ZSTD,
fin_age_old varchar(3) ENCODE ZSTD ,
fin_indid varchar(12) ENCODE ZSTD,
fin_hhld varchar(12) ENCODE ZSTD,
file_source varchar(1) ENCODE ZSTD,
addressline1 varchar(30) ENCODE ZSTD,
addressline2 varchar(30) ENCODE ZSTD,
city varchar(28) ENCODE ZSTD,
st varchar(2) ENCODE BYTEDICT,
zip varchar(5)  ENCODE ZSTD,
zip4 varchar(4) ENCODE ZSTD,
dma varchar(1) ENCODE ZSTD,
deceased_flag varchar(1) ENCODE ZSTD,
aca varchar(1) ENCODE ZSTD,
fin_dob varchar(8) ENCODE ZSTD,
fin_ethcode varchar(2) ENCODE ZSTD,
fin_ethgroup varchar(1) ENCODE ZSTD,
fin_language varchar(2) ENCODE ZSTD,
fin_relcode varchar(1) ENCODE ZSTD,
fin_active_trade_line varchar(1) ENCODE ZSTD,
fin_marr_date varchar(7) ENCODE ZSTD,
fin_spflag varchar(1) ENCODE ZSTD,
lems varchar(18) ENCODE ZSTD,
fin_married varchar(1) ENCODE ZSTD,
fin_politic varchar(1) ENCODE ZSTD,
fl_lname varchar(1) ENCODE ZSTD,
ld_zip varchar(1) ENCODE ZSTD,
dqi_match_flag varchar(1) ENCODE ZSTD,
scf varchar(3) ENCODE ZSTD,
age_code varchar(1) ENCODE ZSTD,
comp varchar(5)  ENCODE ZSTD,
matchcode varchar(25) ENCODE ZSTD,
dma_code varchar(3) ENCODE BYTEDICT,
zipfull varchar(9) ENCODE ZSTD,
edb_match_flag varchar(1) ENCODE ZSTD,
md5_email_lower varchar(32) ENCODE ZSTD,
combined_age varchar(1) ENCODE ZSTD,
new_mover_flag varchar(1) ENCODE ZSTD,
new_mover_date varchar(5) ENCODE ZSTD,
smb_flag varchar(1) ENCODE ZSTD,
sic_2 varchar(2) ENCODE ZSTD,
sha1_email varchar(40) ENCODE ZSTD,
infopersona_cluster varchar(2) ENCODE BYTEDICT,
infopersona_supercluster varchar(1) ENCODE ZSTD,
cd_rating_2014 varchar(1) ENCODE ZSTD,
crrt varchar(4) ENCODE BYTEDICT,
lot varchar(5) ENCODE ZSTD,
lotsort varchar(2) ENCODE BYTEDICT,
dpv varchar(3) ENCODE ZSTD,
state_code varchar(2) ENCODE BYTEDICT,
county_code varchar(3) ENCODE BYTEDICT,
ce_income_producing_assets varchar(1) ENCODE ZSTD,
ce_discretionary_income_score varchar(2) ENCODE BYTEDICT,
ce_pensioner_present_flag varchar(1) ENCODE ZSTD,
winmargin varchar(1) ENCODE ZSTD,
educational_model varchar(1) ENCODE ZSTD,
consumer_digital_match varchar(1) ENCODE ZSTD,
buy_segment varchar(1) ENCODE ZSTD,
buy_score varchar(3) ENCODE ZSTD,
execureach_match_flag varchar(1) ENCODE ZSTD,
oneperhhd_mc varchar(18) ENCODE ZSTD,
exec_bus_igid varchar(9) ENCODE ZSTD,
exec_bus_titlecode varchar(1) ENCODE ZSTD,
exec_bus_titlecodedescription varchar(30) ENCODE ZSTD,
exec_bus_employeesizecode varchar(1) ENCODE ZSTD,
exec_bus_locationoutputvolumecode varchar(1) ENCODE ZSTD,
exec_bus_primarysiccode_6digit varchar(6) ENCODE ZSTD,
exec_cons_locationtype varchar(1) ENCODE ZSTD,
exec_bus_fulfillment_flag varchar(1) ENCODE ZSTD,
exec_bus_cbsa varchar(5) ENCODE ZSTD,
exec_bus_cbsalevel varchar(1) ENCODE ZSTD,
exec_bus_companyholdingstatus varchar(1) ENCODE ZSTD,
exec_bus_cottagecode varchar(1) ENCODE ZSTD,
exec_bus_mailscore varchar(2) ENCODE ZSTD,
exec_execureach_type varchar(1) ENCODE ZSTD,
exec_execureach_quality varchar(2) ENCODE ZSTD,
exec_bus_actual_location_employeesize varchar(5) ENCODE ZSTD,
exec_bus_corporate_employeesizecode varchar(1) ENCODE ZSTD,
exec_bus_actual_location_outputvolume varchar(9) ENCODE ZSTD,
exec_bus_corporateoutputvolumecode varchar(1) ENCODE ZSTD,
exec_bus_square_footage varchar(1) ENCODE ZSTD,
exec_bus_credit_alphascore varchar(2) ENCODE ZSTD,
exec_bus_rolecode varchar(4) ENCODE ZSTD,
exec_bus_digitalflag varchar(1) ENCODE ZSTD,
exec_bus_businessstatuscode varchar(1) ENCODE ZSTD,
exec_bus_departmentcode varchar(2) ENCODE ZSTD,
exec_bus_levelcode varchar(1) ENCODE ZSTD,
exec_bus_royalty_record varchar(1) ENCODE ZSTD,
exec_bus_email_md5_lower varchar(32) ENCODE ZSTD,
exec_bus_email_md5_upper varchar(32) ENCODE ZSTD,
exec_bus_contactliteraltitlecode varchar(8) ENCODE ZSTD,
exec_bus_contactliteraltitlecode_description varchar(256) ENCODE ZSTD,
exec_bus_contactid varchar(12) ENCODE ZSTD,
exec_bus_professionaltitle varchar(3) ENCODE ZSTD,
exec_bus_companyname_available varchar(1) ENCODE ZSTD,
exec_bus_sic2 varchar(2) ENCODE ZSTD,
exec_bus_sic4 varchar(4) ENCODE ZSTD,
exec_bus_igid_available varchar(1) ENCODE ZSTD,
bluekaiid varchar(32) ENCODE ZSTD,
bluekai_flag varchar(1) ENCODE ZSTD,
haystaq_array varchar(605) ENCODE ZSTD,
lot_size varchar(5) ENCODE ZSTD,
email_deployable varchar(1) ENCODE ZSTD,
id bigint identity ENCODE ZSTD,
state                           varchar(2) ENCODE LZO ,
zipradius                       varchar(1) ENCODE LZO ,
listid                          int DEFAULT 9357 ENCODE AZ64 ,
permissiontype                  varchar(1) DEFAULT 'R' ENCODE ZSTD,
arr_pay                         varchar(42) DEFAULT '' ENCODE ZSTD,
arr_cc                          varchar(42) DEFAULT '' ENCODE ZSTD,
children_age_presence_flag      varchar(30) DEFAULT '' ENCODE ZSTD,
interest_flag                   varchar(150) DEFAULT '' ENCODE ZSTD,
lifestyle_hobby_interest_flags  varchar(270) DEFAULT '' ENCODE ZSTD,
ailments_flags                  varchar(50) DEFAULT '' ENCODE ZSTD,
credit_card_flag                varchar(50) DEFAULT '' ENCODE ZSTD,
donor_flags                     varchar(12) DEFAULT '' ENCODE ZSTD,
market_target_age_flags         varchar(80) DEFAULT '' ENCODE ZSTD,
children_month_of_birth         varchar(36) DEFAULT '' ENCODE ZSTD,
children_age_by_gender          varchar(150) DEFAULT '' ENCODE ZSTD,
experian_donor_array            varchar(120) DEFAULT '' ENCODE ZSTD,
experian_child_array            varchar(90) DEFAULT '' ENCODE ZSTD,
experian_lifestyle_array        varchar(210) DEFAULT '' ENCODE ZSTD,
dlx_segments                    varchar(500) DEFAULT '' ENCODE ZSTD,
arr_twm                         varchar(500) DEFAULT '' ENCODE ZSTD,
oneperadd_mc varchar(18) ENCODE ZSTD,
fin_age INT ENCODE LZO,
statecountycode varchar(5) ENCODE ZSTD,
individual_mc varchar(17) ENCODE ZSTD,
model_greatcallcluster_decile int ENCODE AZ64,
 pub2_moslo INT ENCODE LZO,
 pub2_total_mag INT ENCODE LZO,
 pub2_total_pub_books INT ENCODE LZO,
 pub2_mag_moslo INT ENCODE LZO,
 pub2_mag_totord INT ENCODE LZO,
 pub2_active_mag INT ENCODE LZO,
 pub2_total_cat_books INT ENCODE LZO,
 pub2_mag_autornwl INT ENCODE LZO,
 pub2_expire_mag INT ENCODE LZO,
 pub2_mag_paid INT ENCODE LZO,
 pub2_mag_paid_cash INT ENCODE LZO,
 publisher2_source_arr VARCHAR ENCODE LZO,
 publisher2_cat1_arr VARCHAR ENCODE LZO,
 publisher2_cat2_arr VARCHAR ENCODE LZO,
 statecity VARCHAR(50) ENCODE ZSTD,
 statecityzip VARCHAR(50) ENCODE ZSTD,
 statecityscf VARCHAR(50) ENCODE ZSTD,
PRIMARY KEY(cid) 
)
DISTSTYLE KEY
DISTKEY(cid)
SORTKEY(cid);


Insert into mgen_new
(
    lrfsid,
    oldid,
    cid,
    firstname,
    lastname,
    fin_gen,
    fin_age_old,
    fin_indid,
    fin_hhld,
    file_source,
    addressline1,
    addressline2,
    city,
    st,
    zip,
    zip4,
    dma,
    deceased_flag,
    aca,
    fin_dob,
    fin_ethcode,
    fin_ethgroup,
    fin_language,
    fin_relcode,
    fin_active_trade_line,
    fin_marr_date,
    fin_spflag,
    lems,
    fin_married,
    fin_politic,
    fl_lname,
    ld_zip,
    dqi_match_flag,
    scf,
    age_code,
    comp,
    matchcode,
    dma_code,
    zipfull,
    edb_match_flag,
    md5_email_lower,
    combined_age,
    new_mover_flag,
    new_mover_date,
    smb_flag,
    sic_2,
    sha1_email,
    infopersona_cluster,
    infopersona_supercluster,
    cd_rating_2014,
    crrt,
    lot,
    lotsort,
    dpv,
    state_code,
    county_code,
    ce_income_producing_assets,
    ce_discretionary_income_score,
    ce_pensioner_present_flag,
    winmargin,
    educational_model,
    consumer_digital_match,
    buy_segment,
    buy_score,
    execureach_match_flag,
    oneperhhd_mc,
    exec_bus_igid,
    exec_bus_titlecode,
    exec_bus_titlecodedescription,
    exec_bus_employeesizecode,
    exec_bus_locationoutputvolumecode,
    exec_bus_primarysiccode_6digit,
    exec_cons_locationtype,
    exec_bus_fulfillment_flag,
    exec_bus_cbsa,
    exec_bus_cbsalevel,
    exec_bus_companyholdingstatus,
    exec_bus_cottagecode,
    exec_bus_mailscore,
    exec_execureach_type,
    exec_execureach_quality,
    exec_bus_actual_location_employeesize,
    exec_bus_corporate_employeesizecode,
    exec_bus_actual_location_outputvolume,
    exec_bus_corporateoutputvolumecode,
    exec_bus_square_footage,
    exec_bus_credit_alphascore,
    exec_bus_rolecode,
    exec_bus_digitalflag,
    exec_bus_businessstatuscode,
    exec_bus_departmentcode,
    exec_bus_levelcode,
    exec_bus_royalty_record,
    exec_bus_email_md5_lower,
    exec_bus_email_md5_upper,
    exec_bus_contactliteraltitlecode,
    exec_bus_contactliteraltitlecode_description,
    exec_bus_contactid,
    exec_bus_professionaltitle,
    exec_bus_companyname_available,
    exec_bus_sic2,
    exec_bus_sic4,
    exec_bus_igid_available,
    bluekaiid,
    bluekai_flag,
    haystaq_array,
    lot_size,
    email_deployable,
    state,
    zipradius,
    arr_pay,
    arr_cc,
    children_age_presence_flag,
    interest_flag,
    lifestyle_hobby_interest_flags,
    ailments_flags,
    credit_card_flag,
    donor_flags,
    market_target_age_flags,
    children_month_of_birth,
    children_age_by_gender,
    experian_donor_array,
    experian_child_array,
    experian_lifestyle_array,
    dlx_segments,
    arr_twm,
    oneperadd_mc,
    fin_age,
    statecountycode,
    individual_mc,
    model_greatcallcluster_decile,
    pub2_moslo,
    pub2_total_mag,
    pub2_total_pub_books,
    pub2_mag_moslo,
    pub2_mag_totord,
    pub2_active_mag,
    pub2_total_cat_books,
    pub2_mag_autornwl,
    pub2_expire_mag,
    pub2_mag_paid,
    pub2_mag_paid_cash,
    publisher2_source_arr,
    publisher2_cat1_arr,
    publisher2_cat2_arr,
    statecity,
    statecityzip,
    statecityscf
)
select 
    a.lrfsid,
a.oldid,
a.cid,
a.firstname,
a.lastname,
a.fin_gen,
a.fin_age_old,
a.fin_indid,
a.fin_hhld,
a.file_source,
a.addressline1,
a.addressline2,
a.city,
a.st,
a.zip,
a.zip4,
a.dma,
a.deceased_flag,
a.aca,
a.fin_dob,
a.fin_ethcode,
a.fin_ethgroup,
a.fin_language,
a.fin_relcode,
a.fin_active_trade_line,
a.fin_marr_date,
a.fin_spflag,
a.lems,
a.fin_married,
a.fin_politic,
a.fl_lname,
a.ld_zip,
a.dqi_match_flag,
a.scf,
a.age_code,
a.comp,
a.matchcode,
a.dma_code,
a.zipfull,
a.edb_match_flag,
a.md5_email_lower,
a.combined_age,
a.new_mover_flag,
a.new_mover_date,
a.smb_flag,
a.sic_2,
a.sha1_email,
a.infopersona_cluster,
a.infopersona_supercluster,
a.cd_rating_2014,
a.crrt,
a.lot,
a.lotsort,
a.dpv,
a.state_code,
a.county_code,
a.ce_income_producing_assets,
a.ce_discretionary_income_score,
a.ce_pensioner_present_flag,
a.winmargin,
a.educational_model,
a.consumer_digital_match,
a.buy_segment,
a.buy_score,
a.execureach_match_flag,
a.oneperhhd_mc,
a.exec_bus_igid,
a.exec_bus_titlecode,
a.exec_bus_titlecodedescription,
a.exec_bus_employeesizecode,
a.exec_bus_locationoutputvolumecode,
a.exec_bus_primarysiccode_6digit,
a.exec_cons_locationtype,
a.exec_bus_fulfillment_flag,
a.exec_bus_cbsa,
a.exec_bus_cbsalevel,
a.exec_bus_companyholdingstatus,
a.exec_bus_cottagecode,
a.exec_bus_mailscore,
a.exec_execureach_type,
a.exec_execureach_quality,
a.exec_bus_actual_location_employeesize,
a.exec_bus_corporate_employeesizecode,
a.exec_bus_actual_location_outputvolume,
a.exec_bus_corporateoutputvolumecode,
a.exec_bus_square_footage,
a.exec_bus_credit_alphascore,
a.exec_bus_rolecode,
a.exec_bus_digitalflag,
a.exec_bus_businessstatuscode,
a.exec_bus_departmentcode,
a.exec_bus_levelcode,
a.exec_bus_royalty_record,
a.exec_bus_email_md5_lower,
a.exec_bus_email_md5_upper,
a.exec_bus_contactliteraltitlecode,
a.exec_bus_contactliteraltitlecode_description,
a.exec_bus_contactid,
a.exec_bus_professionaltitle,
a.exec_bus_companyname_available,
a.exec_bus_sic2,
a.exec_bus_sic4,
a.exec_bus_igid_available,
a.bluekaiid,
a.bluekai_flag,
a.haystaq_array,
a.lot_size,
a.email_deployable,
a.st,
a.zipradius,
NVL(b.arr_pay,''),
NVL(b.arr_cc,''),
NVL(b.children_age_presence_flag,''),
NVL(b.interest_flag,''),
NVL(b.lifestyle_hobby_interest_flags,''),
NVL(b.ailments_flags,''),
NVL(b.credit_card_flag,''),
NVL(b.donor_flags,''),
NVL(b.market_target_age_flags,''),
NVL(b.children_month_of_birth,''),
NVL(b.children_age_by_gender,''),
NVL(b.experian_donor_array,''),
NVL(b.experian_child_array,''),
NVL(b.experian_lifestyle_array,''),
NVL(b.dlx_segments,''),
NVL(b.arr_twm,''),
substring(a.oneperhhd_mc,1,11),
case when a.fin_age_old <> '' then cast(a.fin_age_old as int) else 0 end,
nvl(ltrim(rtrim(a.st)),'')+nvl(ltrim(rtrim(a.county_code)), ''),
getmatchcode(a.firstname, a.lastName, a.addressline1, a.zip, a.comp, 'I'),
isnull(c.ndeciles, 20),
d.pub2_moslo,
d.pub2_total_mag,
d.pub2_total_pub_books,
d.pub2_mag_moslo,
d.pub2_mag_totord,
d.pub2_active_mag,
d.pub2_total_cat_books,
d.pub2_mag_autornwl,
d.pub2_expire_mag,
d.pub2_mag_paid,
d.pub2_mag_paid_cash,
d.publisher2_source_arr,
d.publisher2_cat1_arr,
d.publisher2_cat2_arr,
a.st+trim(upper(a.city)),
a.st+trim(upper(a.city))+trim(a.zip),
a.st+trim(upper(a.city))+trim(a.scf)
from mgen_new_load a
left join mgen_arrays b
on a.cid = b.cid
left join greatcallclustermodel_tobedropped c 
on c.id = a.id
left join mgen_pub2 d
on d.cid = a.cid
;

drop table if exists {maintable_name};
alter table mgen_new rename to {maintable_name};